<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Data Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        .lang-btn.active { background-color: #0ea5e9; }
        #issMap { height: 100%; min-height: 400px; width: 100%; border-radius: 0.5rem; z-index: 0;}
        .dashboard-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
    </style>
</head>
<body class="text-slate-800">
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold" data-translate-key="header_title">ISS Data Dashboard</h1>
                <p class="text-sm text-slate-500" data-translate-key="header_subtitle">Real-Time Information Hub</p>
            </div>
            <div class="flex items-center space-x-4">
                 <a href="index.html" class="hidden sm:block text-sky-600 hover:underline" data-translate-key="back_to_main">Back to Main Site</a>
                 <div>
                    <button id="lang-pt" onclick="setLanguage('pt')" class="lang-btn bg-slate-200 hover:bg-sky-600 hover:text-white font-bold py-1 px-3 rounded-l-lg text-sm transition-colors">PT</button>
                    <button id="lang-en" onclick="setLanguage('en')" class="lang-btn bg-slate-200 hover:bg-sky-600 hover:text-white font-bold py-1 px-3 rounded-r-lg text-sm transition-colors">EN</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="dashboard-card h-full flex flex-col">
                    <h2 class="text-xl font-semibold mb-4" data-translate-key="map_title">ISS Current Location</h2>
                    <div id="issMap" class="flex-grow"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="dashboard-card">
                    <h2 class="text-xl font-semibold mb-4" data-translate-key="flight_data_title">Live Flight Data</h2>
                    <div class="space-y-3 text-slate-600">
                        <p><strong data-translate-key="latitude">Latitude:</strong> <span id="lat">...</span></p>
                        <p><strong data-translate-key="longitude">Longitude:</strong> <span id="lon">...</span></p>
                        <p><strong data-translate-key="altitude">Altitude:</strong> <span id="alt">...</span> km</p>
                        <p><strong data-translate-key="velocity">Velocity:</strong> <span id="vel">...</span> km/h</p>
                    </div>
                </div>
                <div class="dashboard-card">
                    <h2 class="text-xl font-semibold mb-4" data-translate-key="crew_title">Who is in Space?</h2>
                    <ul id="crew-list" class="space-y-2 text-slate-600">
                        <li data-translate-key="loading">Loading...</li>
                    </ul>
                </div>
                 <div class="dashboard-card">
                    <h2 class="text-xl font-semibold mb-2" data-translate-key="passes_title">Next Pass Times</h2>
                    <p class="text-sm text-slate-500 mb-4" data-translate-key="passes_desc">
                        Click the button and allow location access to see the next times the ISS will be visible from your sky.
                    </p>
                    <button id="location-btn" onclick="getUserLocation()" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg mb-4 transition-colors" data-translate-key="location_btn">Use My Location</button>
                    <div id="passes-info" class="text-slate-600 text-sm"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentLanguage = localStorage.getItem('language') || 'en';
        const translations = {
            pt: {
                header_title: "Painel de Dados da ISS", header_subtitle: "Central de Informações em Tempo Real", back_to_main: "Voltar ao Site Principal",
                map_title: "Localização Atual da ISS", flight_data_title: "Dados de Voo em Direto",
                latitude: "Latitude:", longitude: "Longitude:", altitude: "Altitude:", velocity: "Velocidade:",
                crew_title: "Quem está no Espaço?", crew_error: "Não foi possível carregar os dados da tripulação.",
                passes_title: "Próximas Passagens Visíveis", passes_desc: "Clique no botão e permita o acesso à localização para ver as próximas vezes que a ISS será visível no seu céu.", location_btn: "Usar a Minha Localização",
                loading: "A carregar...", location_fetching: "A obter a sua localização...", location_denied: "Permissão de localização negada. Não é possível calcular as passagens.", passes_error: "Não foi possível obter os dados das passagens.",
                pass_time_label: "Horário", pass_duration_label: "Duração", no_passes: "Nenhuma passagem futura encontrada para a sua localização."
            },
            en: {
                header_title: "ISS Data Dashboard", header_subtitle: "Real-Time Information Hub", back_to_main: "Back to Main Site",
                map_title: "ISS Current Location", flight_data_title: "Live Flight Data",
                latitude: "Latitude:", longitude: "Longitude:", altitude: "Altitude:", velocity: "Velocity:",
                crew_title: "Who is in Space?", crew_error: "Could not load crew data.",
                passes_title: "Next Pass Times", passes_desc: "Click the button and allow location access to see the next times the ISS will be visible from your sky.", location_btn: "Use My Location",
                loading: "Loading...", location_fetching: "Fetching your location...", location_denied: "Location permission denied. Cannot calculate passes.", passes_error: "Could not fetch pass data.",
                pass_time_label: "Time", pass_duration_label: "Duration", no_passes: "No upcoming passes found for your location."
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang; localStorage.setItem('language', lang);
            document.documentElement.lang = currentLanguage === 'pt' ? 'pt-BR' : 'en-US';
            document.querySelectorAll('[data-translate-key]').forEach(el => { el.innerText = translations[currentLanguage][el.getAttribute('data-translate-key')] || el.innerText; });
            document.getElementById('lang-pt').classList.toggle('active', currentLanguage === 'pt');
            document.getElementById('lang-en').classList.toggle('active', currentLanguage === 'en');
        }

        const map = L.map('issMap').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        const issIcon = L.icon({ iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d0/International_Space_Station.svg', iconSize: [50, 50], iconAnchor: [25, 25], });
        const marker = L.marker([0, 0], {icon: issIcon}).addTo(map);

        async function getISSData() {
            try {
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const data = await response.json();
                const { latitude, longitude, altitude, velocity } = data;
                marker.setLatLng([latitude, longitude]); map.panTo([latitude, longitude], { animate: true, duration: 1.0 });
                document.getElementById('lat').textContent = latitude.toFixed(4);
                document.getElementById('lon').textContent = longitude.toFixed(4);
                document.getElementById('alt').textContent = altitude.toFixed(2);
                document.getElementById('vel').textContent = velocity.toFixed(2);
            } catch (error) { console.error("Error fetching ISS data:", error); }
        }
        
        async function getCrewData() {
            const crewList = document.getElementById('crew-list');
            const crewApiUrl = `https://corsproxy.io/?${encodeURIComponent('http://api.open-notify.org/astros.json')}`;
            try {
                const response = await fetch(crewApiUrl);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();
                crewList.innerHTML = '';
                const issCrew = data.people.filter(person => person.craft === 'ISS');
                if (issCrew.length > 0) {
                    issCrew.forEach(person => {
                        const li = document.createElement('li');
                        li.textContent = person.name;
                        crewList.appendChild(li);
                    });
                } else {
                     crewList.innerHTML = `<li>${translations[currentLanguage].crew_error}</li>`;
                }
            } catch (error) {
                console.error("Error fetching crew data:", error);
                crewList.innerHTML = `<li>${translations[currentLanguage].crew_error}</li>`;
            }
        }
        
        function getUserLocation() {
            const passesInfo = document.getElementById('passes-info');
            passesInfo.innerHTML = `<p>${translations[currentLanguage].location_fetching}</p>`;
            navigator.geolocation.getCurrentPosition(fetchPasses, handleLocationError);
        }

        // FUNÇÃO DE PASSAGENS CORRIGIDA E REFORÇADA
        async function fetchPasses(position) {
            const { latitude, longitude } = position.coords;
            const passesInfo = document.getElementById('passes-info');
            const apiUrl = `http://api.open-notify.org/iss-pass.json?lat=${latitude}&lon=${longitude}&n=5`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();
                passesInfo.innerHTML = '';
                if (data.message === "success" && data.response && data.response.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'w-full text-left';
                    table.innerHTML = `<thead><tr><th class="font-semibold">${translations[currentLanguage].pass_time_label}</th><th class="font-semibold">${translations[currentLanguage].pass_duration_label}</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    data.response.forEach(pass => {
                        const date = new Date(pass.risetime * 1000);
                        const row = document.createElement('tr');
                        row.innerHTML = `<td class="py-1">${date.toLocaleString()}</td><td>${Math.round(pass.duration / 60)} min</td>`;
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);
                    passesInfo.appendChild(table);
                } else {
                    passesInfo.innerHTML = `<p>${translations[currentLanguage].no_passes}</p>`;
                }
            } catch (error) {
                passesInfo.innerHTML = `<p>${translations[currentLanguage].passes_error}</p>`;
                console.error("Error fetching pass times:", error);
            }
        }
        
        function handleLocationError(error) {
            const passesInfo = document.getElementById('passes-info');
            if (error.code === error.PERMISSION_DENIED) {
                passesInfo.innerHTML = `<p>${translations[currentLanguage].location_denied}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLanguage);
            getISSData();
            getCrewData();
            setInterval(getISSData, 5000);
        });
    </script>
</body>
</html>


